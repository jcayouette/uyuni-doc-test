<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring with Icinga :: Uyuni Documentation (Prototype)</title>
    <meta name="generator" content="Antora 1.0.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/site-extra.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
    <!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css -->
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://jcayouette.github.io/personal-blog">Belief and Reason</a>
        <span class="separator">//</span>
        <a href="../..">Library</a>
      </div>
      <div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>Resources</strong></div>
            <a class="navbar-item" href="https://github.com/jcayouette/personal-blog">Repository</a>
            <a class="navbar-item" href="https://github.com/jcayouette/personal-blog/issues">Issue Tracker</a>
<!--
            <hr class="navbar-divider">
            <div class="navbar-item"><strong>Custom UI (coming soon!)</strong></div>
            <a class="navbar-item" href="https://gitlab.com/antora/antora-ui-default">Repository</a>
            <a class="navbar-item" href="https://gitlab.com/antora/antora-ui-default/issues">Issue Tracker</a>
            <hr class="navbar-divider">
          -->
            <a class="navbar-item" href="https://github.com/jcayouette/blob/master/contributing.adoc">Contributing</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Community</div>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vmrAYE3">Discord Chat</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/BaR-project">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="uyuni" data-version="3.2">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="MAIN-manager.html">Uyuni</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="book_mgr_getting_started.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="quickstart3_chap_install_overview.html">Overview and Requirements</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.introduction">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq">Prerequisites for Installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.scc">SUSE SCC Credentials</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.installmedia">Get Uyuni</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.hardware">Hardware Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.network">Network Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.prereq.clientos">Supported Client Systems</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="quickstart3_chap_suma_installation_jeos.html">Installation via JeOS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#quickstart.sect.kvm.settings">Configuring KVM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#jeos.kvm.settings">JeOS KVM Settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#jeos.susemgr.prep">Preparing JeOS for Uyuni</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_installation_sles.html">Installation via SLES</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_setup_with_yast.html">Setup and Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_keys_and_first_client.html">Connecting Clients</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart3_chap_suma_salt_gs.html">Introduction to Salt</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="book_mgr_best_practices.html">Best Practices</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="book_suma_reference_manual.html">WebUI Reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="book_suma_advanced_topics.html">Advanced Topics</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Uyuni</span>
    <span class="version">3.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Uyuni</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../dev/MAIN-manager.html">dev</a>
        </li>
        <li class="version is-current">
          <a href="MAIN-manager.html">3.2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../dev/MAIN-manager.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="MAIN-manager.html">Uyuni</a></li>
    <li class="crumb"><a href="advanced_topics_monitoring_with_icinga.html">Monitoring with Icinga</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">3.2</button>
  <div class="versions-menu">
    <a class="version" href="../dev/advanced_topics_monitoring_with_icinga.html">dev</a>
    <a class="version is-current" href="advanced_topics_monitoring_with_icinga.html">3.2</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/jcayouette/uyuni-doc-test/edit/maintenance/3.2/docs/modules/ROOT/pages/advanced_topics_monitoring_with_icinga.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Monitoring with Icinga</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#at.introduction.to.icinga">Introduction</a></li>
<li><a href="#at.installation.and.basic.configuration.icinga">Installation and Basic Configuration</a></li>
<li><a href="#at.icinga.nrpe.quickstart">Icinga and NRPE Quickstart</a>
<ul class="sectlevel2">
<li><a href="#at.add.a.host.to.icinga">Add a Host to Icinga</a></li>
<li><a href="#at.adding.services.to.icinga">Adding Services to Icinga</a></li>
<li><a href="#at.creating.icinga.hostgroups">Creating Icinga Hostgroups</a></li>
<li><a href="#at.creating.icinga.servicegroups">Creating Icinga Servicegroups</a></li>
</ul>
</li>
<li><a href="#at.monitoring.systemd.services">Monitoring Systemd Services</a></li>
<li><a href="#at.using.the.check.suma.patches.plugin">Using the check_suma_patches Plugin</a></li>
<li><a href="#at.using.the.check.suma.lastevent.plugin">Using the check_suma_lastevent Plugin</a></li>
<li><a href="#at.icinga.additional.resources.">Additional Resources</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="at.introduction.to.icinga"><a class="anchor" href="#at.introduction.to.icinga"></a><a class="link" href="#at.introduction.to.icinga">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter provides guidance on the setup of an Icinga server using SLES 12 SP3.
For more information, see the Official Icinga documentation: <a href="http://docs.icinga.org/latest/en/" class="bare">http://docs.icinga.org/latest/en/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="at.installation.and.basic.configuration.icinga"><a class="anchor" href="#at.installation.and.basic.configuration.icinga"></a><a class="link" href="#at.installation.and.basic.configuration.icinga">Installation and Basic Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Icinga packages are found in the <code>SLE-Manager-Tools12-Updates x86_64</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title=":bulb:"></i>
</td>
<td class="content">
<div class="title">Icinga Installation Location</div>
<div class="paragraph">
<p>Do not install Icinga on the  server.
Install Icinga on a stand-alone SUSE Linux Enterprise client.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure: Installation and Basic Configuration</div>
<ol class="arabic">
<li>
<p>Register the new client with  and subscribe it to the  client and update channels.
SLES 12 and later include these channels by default.</p>
</li>
<li>
<p>Install the required Icinga packages on the new client:</p>
<div class="listingblock">
<div class="content">
<pre>zypper in icinga icinga-idoutils-pgsql postgresql postgresql94-server \
monitoring-plugins-all apache2</pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>/etc/icinga/objects/contacts.cfg</code> file and add the email address which you will use for reciving alerts.</p>
<div class="listingblock">
<div class="content">
<pre>define contact {
  contact_name      icingaadmin          ; Short name of user
  use               generic-contact      ; Inherit default values
  alias             Icinga Admin         ; Full name of user
  email             icinga@localhost     ; &lt;&lt;*** CHANGE THIS TO YOUR EMAIL ADDRESS ***
}</pre>
</div>
</div>
</li>
<li>
<p>Enable postgres on boot and start the database:</p>
<div class="listingblock">
<div class="content">
<pre>systemctl enable postgresql.service
systemctl start postgresql.service</pre>
</div>
</div>
</li>
<li>
<p>Create the database and user for Icinga:</p>
<div class="listingblock">
<div class="content">
<pre>&gt;psql
 postgres=# ALTER USER postgres WITH PASSWORD '&lt;newpassword&gt;';
 postgres=# CREATE USER icinga;
 postgres=# ALTER USER icinga WITH PASSWORD 'icinga';
 postgres=# CREATE DATABASE icinga;
 postgres=# GRANT ALL ON DATABASE icinga TO icinga;
 postgres=# \q
 exit</pre>
</div>
</div>
</li>
<li>
<p>Adjust client authentication rights located in <code>/var/lib/pgsql/data/pg_hba.conf</code> to match the following:</p>
<div class="listingblock">
<div class="content">
<pre># TYPE  DATABASE        USER            ADDRESS                 METHOD
local   icinga         icinga                                  trust
local   all            postgres                                ident

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
# Allow replication connections from localhost, by a user with the
# replication privilege.
#local   replication     postgres                                peer
#host    replication     postgres        127.0.0.1/32            ident
#host    replication     postgres        ::1/128                 ident</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title=":heavy_exclamation_mark:"></i>
</td>
<td class="content">
<div class="title">Placement of Authentication Settings</div>
<div class="paragraph">
<p>Ensure the local entries for icinga authentication settings are placed above all other local entries or you will get an error when configuring the database schema.
The entries in <code class="path">pg_hba.conf</code> are read from top to bottom.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Reload the Postgres service:</p>
<div class="listingblock">
<div class="content">
<pre>systemctl reload postgresql.service</pre>
</div>
</div>
</li>
<li>
<p>Configure the database schema by running the following command in <code class="path">/usr/share/doc/packages/icinga-idoutils-pgsql/pgsql/</code>:</p>
<div class="listingblock">
<div class="content">
<pre>psql -U icinga -d icinga &lt; pgsql.sql</pre>
</div>
</div>
</li>
<li>
<p>Edit the following lines in <code>/etc/icinga/ido2db.cfg</code> to switch from the default setting of mysql to postgres:</p>
<div class="listingblock">
<div class="content">
<pre>vi /etc/icinga/ido2db.cfg

 db_servertype=pgsql
 db_port=5432</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title=":heavy_exclamation_mark:"></i>
</td>
<td class="content">
<div class="title">Open Firewall Port</div>
<div class="paragraph">
<p>Allow port <code>5432</code> through your firewall or you will not be able to access the WebGUI.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create an icinga admin account for logging into the web interface:</p>
<div class="listingblock">
<div class="content">
<pre>htpasswd -c /etc/icinga/htpasswd.users icingaadmin</pre>
</div>
</div>
</li>
<li>
<p>Enable and start all required services:</p>
<div class="listingblock">
<div class="content">
<pre>systemctl enable icinga.service
systemctl start icinga.service
systemctl enable ido2db.service
systemctl start ido2db.service
systemctl enable apache2.service
systemctl start apache2.service</pre>
</div>
</div>
</li>
<li>
<p>Login to the WebGUI at: <a href="http://localhost/icinga" class="bare">http://localhost/icinga</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes setup and initial configuration of Icinga.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="at.icinga.nrpe.quickstart"><a class="anchor" href="#at.icinga.nrpe.quickstart"></a><a class="link" href="#at.icinga.nrpe.quickstart">Icinga and NRPE Quickstart</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections provides an overview on monitoring your  server using Icinga.
You will add  as a host to Icinga and use a Nagios script/plugin to monitor running services via <code>NRPE</code> (Nagios Remote Plugin Executor).
This section does not attempt to cover all monitoring solutions Icinga has to offer but should help you get started.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Adding to Icinga for Monitoring</div>
<ol class="arabic">
<li>
<p>On your  server install the required packages:</p>
<div class="listingblock">
<div class="content">
<pre>zypper install nagios-nrpe susemanager-nagios-plugin insserv nrpe monitoring-plugins-nrpe</pre>
</div>
</div>
</li>
<li>
<p>Modify the NRPE configuration file located at:</p>
<div class="listingblock">
<div class="content">
<pre>/etc/nrpe.cfg</pre>
</div>
</div>
<div class="paragraph">
<p>Edit or add the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>server_port=5666
nrpe_user=nagios
nrpe_group=nagios
allowed_hosts=Icinga.example.com
dont_blame_nrpe=1
command[check_systemd.sh]=/usr/lib/nagios/plugins/check_systemd.sh $ARG1$</pre>
</div>
</div>
<div class="paragraph">
<p>Variable definitions:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">server_port</dt>
<dd>
<p>The variable <code>server_port</code> defines the port nrpe will listen on.
The default port is 5666.
This port must be opened in your firewall.</p>
</dd>
<dt class="hdlist1">nrpe_user</dt>
<dd>
<p>The variables <code>nrpe_user</code> and <code>nrpe_group</code> control the user and group IDs that nrpe will run under. 
probes need access to the database, therefore nrpe requires access to database credentials stored in <code class="path">/etc/rhn/rhn.conf</code>.
There are multiple ways to achieve this.
You may add the user <code>nagios</code> to the group <code>www</code> (this is already done for other IDs such as tomcat); alternatively you can simply have nrpe run with the effective group ID <code>www</code> in <code class="path">/etc/rhn/rhn.conf</code>.</p>
</dd>
<dt class="hdlist1">allowed_hosts</dt>
<dd>
<p>The variable <code>allowed_hosts</code> defines which hosts nrpe will accept connections from.
Enter the FQDN or IP address of your Icinga server here.</p>
</dd>
<dt class="hdlist1">dont_blame_nrpe</dt>
<dd>
<p>The use of variable <code>dont_blame_nrpe</code> is unavoidable in this example.
<code>nrpe</code> commands by default will not allow arguments being passed due to security reasons.
However, in this example you should pass the name of the host you want information on to nrpe as an argument.
This action is only possible when setting the variable to 1.</p>
</dd>
<dt class="hdlist1">command[check_systemd.sh]</dt>
<dd>
<p>You need to define the command(s) that nrpe can run on .
To add a new nrpe command specify a command call by adding <code>command</code> followed by square brackets containing the actual nagios/icinga plugin name.
Next define the location of the script to be called on your  server.
Finally the variable <code>$ARG1$</code> will be replaced by the actual host the Icinga server would like information about.
In the example above, the command is named <code>check_systemd.sh</code>.
You can specify any name you like but keep in mind the command name is the actual script stored in <code class="path">/usr/lib/nagios/plugins/</code> on your  server.
This name must also match your probe definition on the Icinga server.
<em>This will be described in greater detail later in the chapter. The check_systemd.sh script/plugin will also be provided in a later section.</em></p>
</dd>
</dl>
</div>
</li>
<li>
<p>One your configuration is complete load the new nrpe configuration as root with:</p>
<div class="listingblock">
<div class="content">
<pre>systemctl start nrpe</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes setup of nrpe.</p>
</div>
<div class="sect2">
<h3 id="at.add.a.host.to.icinga"><a class="anchor" href="#at.add.a.host.to.icinga"></a><a class="link" href="#at.add.a.host.to.icinga">Add a Host to Icinga</a></h3>
<div class="paragraph">
<p>To add a new host to Icinga create a host.cfg file for each host in <code class="path">/etc/icinga/conf.d/</code>.
For example <code class="path">susemanager.cfg</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>define host {
  host_name           susemanager
  alias               SUSE Manager
  address             192.168.1.1
  check_period        24x7
  check_interval      1
  retry_interval      1
  max_check_attempts  10
  check_command       check-host-alive
}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Place the host IP address you want to add to Icinga on the <code>Address</code> line.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After adding a new host restart Icinga as root to load the new configuation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>systemctl restart icinga</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="at.adding.services.to.icinga"><a class="anchor" href="#at.adding.services.to.icinga"></a><a class="link" href="#at.adding.services.to.icinga">Adding Services to Icinga</a></h3>
<div class="paragraph">
<p>To add services for monitoring on a specific host define them by adding a service definition to your host.cfg file located in <code class="path">/etc/icinga/conf.d</code>.
For example you can monitor if a systems SSH service is running with the following service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>define service {
  host_name           susemanager
  use                 generic-service
  service_description SSH
  check_command       check_ssh
  check_interval      60
}</pre>
</div>
</div>
<div class="paragraph">
<p>After adding any new services restart Icinga as root to load the new configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>systemctl restart icinga</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="at.creating.icinga.hostgroups"><a class="anchor" href="#at.creating.icinga.hostgroups"></a><a class="link" href="#at.creating.icinga.hostgroups">Creating Icinga Hostgroups</a></h3>
<div class="paragraph">
<p>You can create hostgroups to simplify and visualize hosts logically.
Create a <code class="path">hostgroups.cfg</code> file located in <code class="path">/etc/icinga/conf.d/</code> and add the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>define hostgroup {
  hostgroup_name  ssh_group
  alias           ssh group
  members         susemanager,mars,jupiter,pluto,examplehost4
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>members</code> variable should contain the <code>host_name</code> from within each host.cfg file you created to represent your hosts.
Every time you add an additional host by creating a host.cfg ensure you add the host_name to the members list of included hosts if you want it to be included within a logical hostgroup.</p>
</div>
<div class="paragraph">
<p>After adding several hosts to a hostgroup restart Icinga as root to load the new configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>systemctl restart icinga</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="at.creating.icinga.servicegroups"><a class="anchor" href="#at.creating.icinga.servicegroups"></a><a class="link" href="#at.creating.icinga.servicegroups">Creating Icinga Servicegroups</a></h3>
<div class="paragraph">
<p>You can create logical groupings of services as well.
For example if you would like to create a group of essential  services which are running define them within a <code class="path">servicegroups.cfg</code> file placed in <code class="path">/etc/icinga/conf.d/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#Servicegroup 1
define servicegroup {
  servicegroup_name     SUSE Manager Essential Services
  alias                 Essential Services
}

#Servicegroup 2
define servicegroup {
  servicegroup_name     Client Patch Status
  alias                 SUSE Manager 3 Client Patch Status
}</pre>
</div>
</div>
<div class="paragraph">
<p>Within each host&#8217;s <code class="path">host.cfg</code> file add a service to a servicegroup with the following variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>define service {
  use                 generic-service
  service_description SSH
  check_command       check_ssh
  check_interval      60
  servicegroups       SUSE Manager Essential Services
}</pre>
</div>
</div>
<div class="paragraph">
<p>All services that include the <code>servicegroups</code> variable and the name of the servicegroup will be added to the specified servicegroup.
After adding services to a servicegroup restart Icinga as root to load the new configuation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>systemctl restart icinga</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="at.monitoring.systemd.services"><a class="anchor" href="#at.monitoring.systemd.services"></a><a class="link" href="#at.monitoring.systemd.services">Monitoring Systemd Services</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following section provides information on monitoring uptime of critical  services.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Monitoring Running Systemd Services</div>
<ol class="arabic">
<li>
<p>As root create a new plugin file called <code class="path">check_systemd.sh</code> in <code class="path">/usr/lib/nagios/plugins/</code> on your  server:</p>
<div class="listingblock">
<div class="content">
<pre>vi /usr/lib/nagios/plugins/ check_systemd.sh</pre>
</div>
</div>
</li>
<li>
<p>For this example you will use an opensource community script to monitor Systemd services.
You may also wish to write your own.</p>
<div class="listingblock">
<div class="content">
<pre>#!/bin/bash
# Copyright (C) 2016 Mohamed El Morabity &lt;melmorabity@fedoraproject.com&gt;
#
# This module is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# This software is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.

PLUGINDIR=$(dirname $0)
. $PLUGINDIR/utils.sh


if [ $# -ne 1 ]; then
    echo "Usage: ${0##*/} &lt;service name&gt;" &gt;&amp;2
    exit $STATE_UNKNOWN
fi

service=$1

status=$(systemctl is-enabled $service 2&gt;/dev/null)
r=$?
if [ -z "$status" ]; then
    echo "ERROR: service $service doesn't exist"
    exit $STATE_CRITICAL
fi

if [ $r -ne 0 ]; then
    echo "ERROR: service $service is $status"
    exit $STATE_CRITICAL
fi

systemctl --quiet is-active $service
if [ $? -ne 0 ]; then
    echo "ERROR: service $service is not running"
    exit $STATE_CRITICAL
fi

echo "OK: service $service is running"
exit $STATE_OK</pre>
</div>
</div>
<div class="paragraph">
<p>A current version of this script can be found at: <a href="https://github.com/melmorabity/nagios-plugin-systemd-service/blob/master/check_systemd_service.sh" class="bare">https://github.com/melmorabity/nagios-plugin-systemd-service/blob/master/check_systemd_service.sh</a></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title=":warning:"></i>
</td>
<td class="content">
<div class="title">Non-supported 3rd Party Plugin</div>
<div class="paragraph">
<p>The script used in this example is an external script and is not supported by SUSE.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Always check to ensure scripts are not modified or contain malicous code before using them on production machines.</p>
</div>
</li>
<li>
<p>Make the script executable:</p>
<div class="listingblock">
<div class="content">
<pre>chmod 755 check_systemd.sh</pre>
</div>
</div>
</li>
<li>
<p>On your SUSE manager server add the following line to the <code class="path">nrpe.cfg</code> located at <code class="path">/etc/nrpe.cfg</code> :</p>
<div class="listingblock">
<div class="content">
<pre># SUSE Manager Service Checks
command[check_systemd.sh]=/usr/lib/nagios/plugins/check_systemd.sh $ARG1$</pre>
</div>
</div>
<div class="paragraph">
<p>This will allow the Icinga server to call the plugin via nrpe on .</p>
</div>
</li>
<li>
<p>Provide proper permissions by adding the script to the sudoers file:</p>
<div class="listingblock">
<div class="content">
<pre>visudo</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>nagios  ALL=(ALL)       NOPASSWD:/usr/lib/nagios/plugins/check_systemd.sh
Defaults:nagios !requiretty</pre>
</div>
</div>
<div class="paragraph">
<p>You can also add permissions to the entire plugin directory instead of allowing permissions for individual scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>nagios  ALL=(ALL)       NOPASSWD:/usr/lib/nagios/plugins/</pre>
</div>
</div>
</li>
<li>
<p>On your Icinga server define the following command within <code class="path">/etc/icinga/objects/commands.cfg</code> :</p>
<div class="listingblock">
<div class="content">
<pre>define command {
        command_name   check-systemd-service
        command_line   /usr/lib/nagios/plugins/check_nrpe -H $HOSTADDRESS$ -c check_systemd.sh -a $ARG1$
}</pre>
</div>
</div>
</li>
<li>
<p>Now you will add the following critical services to be montitored to your  host file:</p>
<div class="ulist">
<ul>
<li>
<p>auditlog-keeper.service</p>
</li>
<li>
<p>jabberd.service</p>
</li>
<li>
<p>spacewalk-wait-for-jabberd.service</p>
</li>
<li>
<p>tomcat.service</p>
</li>
<li>
<p>spacewalk-wait-for-tomcat.service</p>
</li>
<li>
<p>salt-master.service</p>
</li>
<li>
<p>salt-api.service</p>
</li>
<li>
<p>spacewalk-wait-for-salt.service</p>
</li>
<li>
<p>apache2.service</p>
</li>
<li>
<p>osa-dispatcher.service</p>
</li>
<li>
<p>rhn-search.service</p>
</li>
<li>
<p>cobblerd.service</p>
</li>
<li>
<p>taskomatic.service</p>
</li>
<li>
<p>spacewalk-wait-for-taskomatic.service</p>
<div class="paragraph">
<p>On your Icinga server add the following service blocks to your  host file <code class="path">susemanager.cfg</code> file located in <code class="path">/etc/icinga/conf.d/</code>.
(This configuration file was created in the previous section <em>Adding a Host to Icinga</em>.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Monitor Audit Log Keeper
define service {
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Audit Log Keeper Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!auditlog-keeper.service

}

# Monitor Jabberd
define service {
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Jabberd Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!jabberd.service

}

# Monitor Spacewalk Wait for Jabberd
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Spacewalk Wait For Jabberd Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!spacewalk-wait-for-jabberd.service
}

# Monitor Tomcat
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Tomcat Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!tomcat.service
}

# Monitor Spacewalk Wait for Tomcat
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Spacewalk Wait For Tomcat Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!spacewalk-wait-for-tomcat.service
}

# Monitor Salt Master
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Salt Master Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!salt-master.service
}

# Monitor Salt API
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Salt API Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!salt-api.service
}

# Monitor Spacewalk Wait for Salt
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Spacewalk Wait For Salt Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!spacewalk-wait-for-salt.service
}

# Monitor apache2
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Apache2 Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!apache2.service
}

# Monitor osa dispatcher
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Osa Dispatcher Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!osa-dispatcher.service
}

# Monitor rhn search
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    RHN Search Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!rhn-search.service
}

# Monitor Cobblerd
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Cobblerd Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!cobblerd.service
}

# Monitor taskomatic
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Taskomatic Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!taskomatic.service
}

# Monitor wait for taskomatic
define service{
       use                    generic-service
       host_name              susemanager
       check_interval         1
       active_checks_enabled  1
       service_description    Spacewalk Wait For Taskomatic Service
       servicegroups          SUSE Manager Essential Services
       check_command          check-systemd-service!spacewalk-wait-for-taskomatic.service
}</pre>
</div>
</div>
<div class="paragraph">
<p>Each of these service blocks will be passed as the check-systemd-service!$ARG1$ variable to SUSE manager server via nrpe.
You probably noticed the servicegroups parameter was also included.
This adds each service to a servicegroup and has been defined in a <code class="path">servicesgroups.cfg</code> file located in <code class="path">/etc/icinga/conf.d/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>define servicegroup {
       servicegroup_name     SUSE Manager Essential Services
       alias                 Essential Services
}</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Restart Icinga:</p>
<div class="listingblock">
<div class="content">
<pre>systemctl restart icinga</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="at.using.the.check.suma.patches.plugin"><a class="anchor" href="#at.using.the.check.suma.patches.plugin"></a><a class="link" href="#at.using.the.check.suma.patches.plugin">Using the check_suma_patches Plugin</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use the <code class="path">check_suma_patches</code> plugin to check if any machines connected to  as clients require a patch or an update.
The following procedure will guide you through the setup of the check_suma_patches plugin.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Setup check_suma_patches</div>
<ol class="arabic">
<li>
<p>On your  server open <code class="path">/etc/nrpe.cfg</code> and add the following lines:</p>
<div class="listingblock">
<div class="content">
<pre># SUSE Manager check_patches
command[check_suma_patches]=sudo /usr/lib/nagios/plugins/check_suma_patches $ARG1$</pre>
</div>
</div>
</li>
<li>
<p>On your Icinga server open <code class="path">/etc/icinga/objects/commands.cfg</code> and define the following command:</p>
<div class="listingblock">
<div class="content">
<pre>define command{
        command_name    check_suma
        command_line    /usr/lib/nagios/plugins/check_nrpe -H 192.168.1.1 -c $ARG1$ -a $HOSTNAME$
}</pre>
</div>
</div>
</li>
<li>
<p>On your Icinga server open any of your  client host configration files located at <code class="path">/etc/icinga/conf.d/clients.cfg</code> and add the following service definition:</p>
<div class="listingblock">
<div class="content">
<pre>define service {
        use                             generic-service
        host_name                       client-hostname
        service_description             Available Patches for client-host_name
        servicegroups                   Client Patch Status
        check_command                   check_suma!check_suma_patches
}</pre>
</div>
</div>
</li>
<li>
<p>In the above service definition notice that this host is included in the servicegroup labeled <em>Client Patch Status</em>.
Add the following servicegroup definition to <code class="path">/etc/icinga/conf.d/servicegroups.cfg</code> to create a servicegroup:</p>
<div class="listingblock">
<div class="content">
<pre>define servicegroup {
       servicegroup_name     Client Patch Status
       alias                 SUSE Manager 3 Client Patch Status
}</pre>
</div>
</div>
</li>
<li>
<p></p>
<div class="ulist">
<ul>
<li>
<p><code>OK:System is up to date</code></p>
</li>
<li>
<p><code>Warning: At least one patch or package update is available</code></p>
</li>
<li>
<p><code>Critical:At least one security/critical update is available</code></p>
</li>
<li>
<p><code>Unspecified:The host cannot be found in the SUSE Manager database or the host name is not unique</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes setup of the <code>check_suma_patches</code> plugin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="at.using.the.check.suma.lastevent.plugin"><a class="anchor" href="#at.using.the.check.suma.lastevent.plugin"></a><a class="link" href="#at.using.the.check.suma.lastevent.plugin">Using the check_suma_lastevent Plugin</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use the <code class="path">check_suma_lastevent</code> plugin to display the last action executed on any host.</p>
</div>
<div class="paragraph">
<p>The following procedure will guide you through the setup of the check_suma_patches plugin.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Setup check_suma_lastevent</div>
<ol class="arabic">
<li>
<p>On your  server open <code class="path">/etc/nrpe.cfg</code> and add the following lines:</p>
<div class="listingblock">
<div class="content">
<pre># Check SUSE Manager Hosts last events
command[check_events]=sudo /usr/lib/nagios/plugins/check_suma_lastevent $ARG1$</pre>
</div>
</div>
</li>
<li>
<p>On the Icinga server open <code class="path">/etc/icinga/objects/commands.cfg</code> and add the following lines:</p>
<div class="listingblock">
<div class="content">
<pre>define command {
        command_name    check_events
        command_line    /usr/lib/nagios/plugins/check_nrpe -H manager.suse.de -c $ARG1$ -a $HOSTNAME$
}</pre>
</div>
</div>
</li>
<li>
<p>On your Icinga server add the following line to a host.cfg service definition:</p>
<div class="listingblock">
<div class="content">
<pre>define service{
        use                             generic-service
        host_name                       hostname
        service_description             Last Events
        check_command                   check_events!check_suma_lastevent
}</pre>
</div>
</div>
</li>
<li>
<p>Status will be reported as follows:</p>
<div class="ulist">
<ul>
<li>
<p><code>OK:Last action completed successfully</code></p>
</li>
<li>
<p><code>Warning: Action is currently in progress</code></p>
</li>
<li>
<p><code>Critical:Last action failed</code></p>
</li>
<li>
<p><code>Unspecified:The host cannot be found in the  database or the host name is not unique</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes setup of the <code>check_suma_lastevent</code> plugin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="at.icinga.additional.resources."><a class="anchor" href="#at.icinga.additional.resources."></a><a class="link" href="#at.icinga.additional.resources.">Additional Resources</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>For more information, see Icinga&#8217;s official documentation located at <a href="http://docs.icinga.org/latest/en" class="bare">http://docs.icinga.org/latest/en</a>.</p>
</div>
<div class="paragraph">
<p>For some excellent time saving configuration tips and tricks not covered in this guide, see the following section located within the official documentation: <a href="http://docs.icinga.org/latest/en/objecttricks.html" class="bare">http://docs.icinga.org/latest/en/objecttricks.html</a></p>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>Copyright (C) 2017-2018 <a href="https://jcayouette.github.io/personal-blog">Belief and Reason</a></p>
  <p>Except where otherwise noted, jcayouette.github.io/personal-blog, BoR, are licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License Version 2.0</a> (MPL-2.0).</p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js -->
<script>
function focusSearchInput () { document.querySelector('#search-input').focus() }
var search = docsearch({
  appId: '#',
  apiKey: '#',
  indexName: '#',
  inputSelector: '#search-input',
  autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
  algoliaOptions: { hitsPerPage: 10 }
}).autocomplete
search.on('autocomplete:closed', function () { search.autocomplete.setVal() })
focusSearchInput()
window.addEventListener('load', focusSearchInput)
</script>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
